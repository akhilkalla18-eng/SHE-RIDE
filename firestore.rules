rules_version = '2';

/**
 * @name Firebase Security Rules for SheRide
 * @description These rules enforce a secure, user-centric data access model for the SheRide application.
 *
 * @philosophy
 * 1. Default to Deny: All paths are closed by default. Access is granted explicitly.
 * 2. User Ownership: Users have full control over their own private data (e.g., profiles).
 * 3. Controlled Public Access: Certain collections (ride requests) are readable by any authenticated user to enable discoverability, but are only writable by their creators.
 * 4. Shared Resource Control: Access to shared documents (like a confirmed ride) is restricted to only the participants involved in that specific document.
 * 5. Immutable Ownership: Key ownership fields (e.g., `riderId`) cannot be changed after a document is created, preventing unauthorized re-assignment of resources.
 */
service cloud.firestore {
  match /databases/{database}/documents {

    // --------------------------------
    // Helper Functions
    // --------------------------------

    /**
     * Returns true if a user is signed in.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Returns true if the requesting user's UID matches the provided userId.
     * This is the primary function for enforcing document ownership.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    /**
     * Returns true if the user is a participant in a given ride.
     * It checks if the user's UID is present in the `participantIds` array of the ride document.
     */
    function isRideParticipant(rideId) {
      return isSignedIn() && request.auth.uid in get(/databases/$(database)/documents/rides/$(rideId)).data.participantIds;
    }

    /**
     * Ensures specified fields in a document cannot be changed during an update.
     * This is used to make fields like creator IDs immutable.
     */
    function areOwnershipFieldsImmutable(fields) {
      // Loop through a list of field names to check for immutability.
      let result = true;
      for (let field in fields) {
        if (request.resource.data[field] != resource.data[field]) {
          result = false;
        }
      }
      return result;
    }

    // --------------------------------
    // Collection Rules
    // --------------------------------

    /**
     * /users/{userId}
     * Stores private user profile information.
     * - READ: Any signed-in user can read a profile (for display purposes).
     * - CREATE: A user can only create their own profile document.
     * - UPDATE: A user can only update their own profile.
     * - DELETE: Not allowed.
     */
    match /users/{userId} {
      allow get: if isSignedIn();
      allow list: if false; // Disallow listing all users for privacy.
      
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isOwner(userId) && areOwnershipFieldsImmutable(['id', 'email']);
      allow delete: if false;
    }

    /**
     * /pickupRequests/{pickupRequestId}
     * Stores ride offers from riders.
     * - LIST/GET: Any authenticated user can read the list of offers to find a ride.
     * - WRITE: Only the owner (the rider) can create, update, or delete their own offer.
     */
    match /pickupRequests/{pickupRequestId} {
      allow list, get: if isSignedIn();
      
      allow create: if isOwner(request.resource.data.riderId);
      allow update, delete: if isOwner(resource.data.riderId) && areOwnershipFieldsImmutable(['riderId']);
    }

    /**
     * /serviceRequests/{serviceRequestId}
     * Stores ride requests from passengers.
     * - LIST/GET: Any authenticated user can read the list of requests to find a passenger.
     * - WRITE: Only the owner (the passenger) can create, update, or delete their own request.
     */
    match /serviceRequests/{serviceRequestId} {
      allow list, get: if isSignedIn();
      
      allow create: if isOwner(request.resource.data.passengerId);
      allow update, delete: if isOwner(resource.data.passengerId) && areOwnershipFieldsImmutable(['passengerId']);
    }

    /**
     * /rides/{rideId}
     * Stores confirmed rides between two participants.
     * - GET/WRITE: Access is granted only to users whose UID is in the `participantIds` array.
     * - LIST: A user can ONLY query for rides where they are a participant. This is enforced
     *   by requiring a `where` clause on the `participantIds` field in the query.
     */
    match /rides/{rideId} {
      allow get, update, delete: if isRideParticipant(rideId);
      allow list: if isSignedIn() && request.query.where.participantIds.includes('array-contains', request.auth.uid);
      allow create: if isSignedIn();
          
      // Subcollection for chat messages within a ride.
      match /chats/{chatId} {
        allow read, write: if isRideParticipant(rideId);
      }
    }

    /**
     * /sos_alerts/{sosAlertId}
     * Stores sensitive emergency alerts.
     * - CREATE: A user can only create an alert for themselves.
     * - READ: A user can only read an alert they created.
     * - LIST/UPDATE/DELETE: Disallowed for security and data integrity.
     */
    match /sos_alerts/{sosAlertId} {
      allow get: if isOwner(resource.data.userId);
      allow create: if isOwner(request.resource.data.userId);

      allow list, update, delete: if false;
    }
  }
}

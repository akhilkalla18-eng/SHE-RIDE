
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    function isSignedIn() {
      return request.auth != null;
    }

    // --- Collection Rules ---

    match /users/{userId} {
      // Create: User can create their own profile document.
      // The document ID and the 'id' field in the document must match the user's UID.
      allow create: if isSignedIn() && request.auth.uid == userId && request.resource.data.id == request.auth.uid;
      
      // Read, Update: User can only read or update their own profile.
      allow read, update: if isSignedIn() && request.auth.uid == userId;

      // Delete: Not allowed from client.
      allow delete: if false;
    }

    match /pickupRequests/{pickupRequestId} {
      // Read: Any authenticated user can read all requests for the suggestions page.
      allow read: if isSignedIn();

      // Create: User must be owner of the new document.
      allow create: if isSignedIn() && request.resource.data.userProfileId == request.auth.uid;

      // Update, Delete: User can only update/delete their own requests.
      allow update, delete: if isSignedIn() && resource.data.userProfileId == request.auth.uid;
    }

    match /serviceRequests/{serviceRequestId} {
      // Read: Any authenticated user can read all requests for the suggestions page.
      allow read: if isSignedIn();

      // Create: User must be owner of the new document.
      allow create: if isSignedIn() && request.resource.data.userProfileId == request.auth.uid;
      
      // Update, Delete: User can only update/delete their own requests.
      allow update, delete: if isSignedIn() && resource.data.userProfileId == request.auth.uid;
    }

    match /rides/{rideId} {
      // A ride can be created if the user is one of the participants.
      allow create: if isSignedIn() && request.auth.uid in request.resource.data.participantIds;
      
      // Only participants can read, update, or delete a ride document.
      allow read, update, delete: if isSignedIn() && request.auth.uid in resource.data.participantIds;
    }

    match /chats/{chatId} {
      // A chat can be created if the user is one of the participants.
      allow create: if isSignedIn() && request.auth.uid in request.resource.data.participantIds;

      // Only participants can read or update a chat document.
      allow read, update: if isSignedIn() && request.auth.uid in resource.data.participantIds;
      
      // Chats cannot be deleted from the client.
      allow delete: if false;
    }

    match /sos_alerts/{sosAlertId} {
      // Create: Only the owner can create an alert.
      allow create: if isSignedIn() && request.resource.data.userProfileId == request.auth.uid;
      
      // Read, Update, Delete: Not allowed from client.
      allow read, update, delete: if false;
    }
  }
}
